#!/usr/bin/env bash
# episodic-knowledge-init: Clone and configure the knowledge repo
set -euo pipefail

BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$BIN_DIR/../lib/knowledge.sh"

if [[ $# -lt 1 ]]; then
    echo "Usage: episodic-knowledge-init <repo-url>" >&2
    exit 1
fi

REPO_URL="$1"

episodic_knowledge_init "$REPO_URL"

# Save repo URL to .env for persistence across sessions
ENV_FILE="$EPISODIC_ROOT/.env"
if [[ -f "$ENV_FILE" ]] && grep -q "EPISODIC_KNOWLEDGE_REPO" "$ENV_FILE" 2>/dev/null; then
    # Update existing line
    sed -i '' "s|^EPISODIC_KNOWLEDGE_REPO=.*|EPISODIC_KNOWLEDGE_REPO=\"$REPO_URL\"|" "$ENV_FILE"
else
    echo "EPISODIC_KNOWLEDGE_REPO=\"$REPO_URL\"" >> "$ENV_FILE"
fi

# Push initial commit if remote is empty
cd "$EPISODIC_KNOWLEDGE_DIR"
if ! git push -u origin main 2>/dev/null; then
    git push -u origin HEAD:main 2>/dev/null || true
fi

echo "Knowledge repo initialized at $EPISODIC_KNOWLEDGE_DIR"
echo "Repo URL saved to $ENV_FILE"
