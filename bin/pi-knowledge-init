#!/usr/bin/env bash
# episodic-knowledge-init: Clone and configure the knowledge repo
set -euo pipefail

BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$BIN_DIR/../lib/knowledge.sh"

if [[ $# -lt 1 ]]; then
    echo "Usage: episodic-knowledge-init <repo-url>" >&2
    exit 1
fi

REPO_URL="$1"

episodic_knowledge_init "$REPO_URL"

# Save repo URL to .env for persistence across sessions
ENV_FILE="$EPISODIC_ROOT/.env"

# Validate repo URL: reject if it contains characters that could inject into .env
# Allow: alphanumeric, :, /, ., -, _, @, ~
if [[ "$REPO_URL" =~ [^a-zA-Z0-9:/.@~_-] ]]; then
    echo "WARNING: Repo URL contains unusual characters. Sanitizing for .env safety." >&2
    # Strip any characters that could be shell metacharacters
    REPO_URL=$(printf '%s' "$REPO_URL" | tr -cd 'a-zA-Z0-9:/.@~_-')
fi

if [[ -f "$ENV_FILE" ]] && grep -q "EPISODIC_KNOWLEDGE_REPO" "$ENV_FILE" 2>/dev/null; then
    # Rebuild .env without the old EPISODIC_KNOWLEDGE_REPO line, then append new
    local_tmp=$(mktemp)
    trap 'rm -f "$local_tmp"' EXIT
    grep -v "^EPISODIC_KNOWLEDGE_REPO=" "$ENV_FILE" > "$local_tmp" || true
    printf 'EPISODIC_KNOWLEDGE_REPO="%s"\n' "$REPO_URL" >> "$local_tmp"
    mv "$local_tmp" "$ENV_FILE"
else
    printf 'EPISODIC_KNOWLEDGE_REPO="%s"\n' "$REPO_URL" >> "$ENV_FILE"
fi

# Push initial commit if remote is empty
cd "$EPISODIC_KNOWLEDGE_DIR"
if ! git push -u origin main 2>/dev/null; then
    git push -u origin HEAD:main 2>/dev/null || true
fi

echo "Knowledge repo initialized at $EPISODIC_KNOWLEDGE_DIR"
echo "Repo URL saved to $ENV_FILE"
